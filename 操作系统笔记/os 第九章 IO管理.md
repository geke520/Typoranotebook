### 第九章 I/O管理

#### 设备管理的功能——设备控制器、通道
1. 设备控制器基本功能
* 接收和识别命令：控制器中有多个寄存器和命令译码器等
* 数据交换：设备控制器与CPU之间通过数据总线实现，设备控制器与设备之间通过数据寄存器实现
* 标识和报告设备的状态：设备控制器中设置了状态寄存器供CPU读取
* 地址识别：设备控制器必须能够识别所控制的每个设备的地址，配置了地址译码器
* 数据缓冲区
* 查错控制

#### I/O控制方式——基本思想、区别
##### 程序控制方式
程序直接控制I/O方式中CPU直接控制I/O操作的过程, 包括测试设备状态、发送读/写命令和传送数据
##### 中断控制方式
1. 从I/O控制器的角度来看
* 对于输入, I/O控制器接收到CPU的读命令, 然后开始从相关的设备读数据
* 一旦数据进入到控制器的数据寄存器, I/O控制器通过中断信号线向CPU发一个中断信号, 表示数据就绪，I/O控制器等待直到CPU请求数据
* 当CPU发出这个请求后, I/O控制器把数据放到数据总线中，然后准备下一次的I/O操作
2. 从CPU的角度来看
* CPU发一个读命令, 然后保存当前程序的上下文环境, 转去执行其他程序
* 在每个指令周期的末尾，CPU检查中断：当有来自I/O控制器的中断时,CPU保存当前运行程序的上下文, 转去执行中断处理程序处理该中断
* CPU从I/O控制器读一个字的数据传送到CPU的寄存器, 并存入主存，然后CPU恢复发出I/O命令的程序的上下文, 继续运行
  * 仅用0.1ms的时间来处理由控制器发来的中断请求
##### DMA方式
1. 中断驱动的I/O是以字节为单位进行的，针对块设备，为了进一步减少CPU对I/O的干预，引入了直接存储器访问（Direct Memory Access，DMA）
2. DMA方式特点
* 数据传输的基本单位是数据块
* 所传送的数据是从设备直接送入内存的，或者相反
* 仅在传送一个或多个数据块的开始和结束时，才需CPU干预
##### 通道方式
1. I/O通道控制方式是一种以内存为中心，实现外设与内存直接交换数据的控制方式
2. 与DMA方式相比，通道所需要CPU干预更少， 每次可以完成多个不连续的数据块传送，而且可
以做到一个通道控制多台设备，从而进一步减轻了CPU的
3. I/O通道具有自己的指令系统，并能实现指令所控制的操作，由CPU发出启动指令启动
4. 通过执行通道程序并与设备控制器共同实现对I/O设备的控制的
#### 缓冲管理（重点难点）
##### 单缓冲管理
* 进程发出I/O请求时，操作系统在主存分配一个缓
冲区，通过缓冲区完成I/O
* 例：从块设备输入处理（性能分析）
1. 将一块输入数据输入缓冲区，时间T
2. 系统将缓冲区数据复制到用户区，时间M
3. CPU对输入的数据处理，时间C
* 无缓冲区时，每一块数据的处理时间为T+M+C
* 单缓冲区时，每一块数据的处理时间为MAX(C,T)+M
##### 双缓冲管理
* 为了加快输入和输出速度，提高设备利用率，引入了双缓冲机制，也称为缓冲对换（Buffer Swapping）
* 双缓冲区时，每一块数据的处理时间为MAX(C,T)
##### 缓冲池管理
* 缓冲区是为特定的生产者和消费者设置的，属于专用缓冲，是一组内存块的链表
* 缓冲池是公用缓冲，包含了一个管理的数据结构及一组操作函数的管理机制，用于管理多个缓冲区
#### SPOOLing系统基本组成
1. SPOOLing系统组成
* 输入井/输出井
  * 磁盘上开辟的两块存储区域，分别容纳I/O设备输入和用户程序输出的数据
  * 井文件：数据一般以文件形式组织管理
  * 所有进程的数据文件链接成为队列输入缓冲区/输出缓冲区
  * 内存中开辟的两块缓冲区，用于缓和CPU和磁盘之间速度不匹配的矛盾
  * 分别作为输入设备传送数据到输入井之间以及输出井到输出设备之间的缓冲
    * 输入进程/输出进程
    * 井管理程序
  * 控制作业与磁盘井之间的信息交换
2. SPOOLing系统特点
* 提高了I/O速度
* 由对低速设备的I/O改为对输入/输出井的存取，缓和了CPU与低速设备的矛盾
* 将独占型设备改造为共享设备
* 实现了虚拟设备功能
* 多个进程同时（并发）地从输入/输出井存取数据，感觉是独占I/O设备
#### 设备独立性——基本概念、优点
1. 设备独立性概念：是指用户在程序中使用的设备与实际使用的设备无关，即在用户程序中仅使用逻辑设备名，也称为设备无关性
2. 设备独立性的优点
* 提高设备分配的灵活性
   * 某设备被占用，可分配其它同类空闲设备
   * 系统增加同类外设时，无需修改源程序即可使用
   * 进程使用设备故障时，系统可分配其它同类设备给进程
* 容易实现I/O重定向
   * 重定向(redirection)：I/O进程，不改变应用程序即可改变设
备完成数据的I/O，例dir>prn
#### 设备分配过程
1. 分配设备
* 根据I/O请求中的物理设备名查找系统设备表SDT，找到该设备的DCT
* 根据DCT中的设备状态字段，判断设备是否正忙
* 若忙，将请求I/O进程的PCB挂在设备队列上；否则计算设备分配的安全性，保证安全的前提下分配给进程
2. 分配控制器
* 给请求I/O的进程分配设备后，在DCT中找到与该设备连接的控制器的COCT
* 根据COCT中的状态字段，判断控制器是否忙碌
* 若忙，将请求I/O进程的PCB挂在控制器等待队列上，否则将控制器分配给进程
3. 分配通道
* 在COCT中找到与控制器连接的通道的CHCT
* 根据CHCT中的状态信息，判断通道是否忙碌
* 若忙，将请求I/O进程的PCB挂在通道等待队列上，否则将通道分配给进程
4. 只有在设备、控制器、通道都分配成功时，设备分配才成功，可启动I/O设备进行数据传送
5. 改进：以逻辑设备名请求I/O